rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
  	function isUserAdmin() {
      return request.auth != null &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.account_type == 'admin';
    }
  
    match /users/{userId} {
      allow create: if request.auth.uid == userId;
      allow read : if true;
      allow update: if request.auth.uid == userId || isUserAdmin();
    }
    
    match /users {
      allow list: if isUserAdmin();
    }
    
    match /properties/{propertyId} {
    
      allow create: if request.auth != null &&
                       request.auth.uid == request.resource.data.owner_uid;
                       
      allow read: if true;
      
      allow update: if 
        request.auth.uid == resource.data.owner_uid || 
        isUserAdmin();
                       
      allow delete: if request.auth != null &&
                       request.auth.uid == get(/databases/$(database)/documents/properties/$(propertyId)).data.owner_uid;
    }
    
    match /deleted_properties/{propertyId} {
      allow create: if request.auth != null &&
                       request.auth.uid == request.resource.data.owner_uid;
      allow read: if isUserAdmin();
    }
    
    match /properties {
      allow list: if isUserAdmin();
    }
    
    match /conversations/{conversationId} {
      
      function isPartOfId() {
        return request.auth.uid in conversationId.split('_');
      }

      function isParticipant() {
        return request.auth.uid in resource.data.participants;
      }
      allow list: if request.auth != null && isParticipant();
      
      allow get: if request.auth != null && 
                 ( (resource != null && isParticipant()) || (resource == null && isPartOfId()) );
      
      allow create: if request.auth != null && 
                       request.auth.uid in request.resource.data.participants;
      allow update: if request.auth != null && isParticipant();

      // --- SUBCOLLECTION: MESSAGES ---
      match /messages/{messageId} {
        allow read, list, create: if request.auth != null && 
                                     request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
      }
    }

    // --- REPORTS ---
    match /reports/{reportId} {
      allow create: if request.auth != null;
      allow read: if isUserAdmin() || (request.auth != null && resource.data.reporterId == request.auth.uid);
      
      allow update: if isUserAdmin();
    }
    
    // --- REVIEWS ---
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow delete: if request.auth != null && 
                       (request.auth.uid == resource.data.userId || isUserAdmin());
      
      // Allow update if:
      // 1. User is author (updating content)
      // 2. User is authenticated (updating likes/dislikes/reports - simplified for now)
      // Note: Ideally we should strictly check which fields are being updated.
      allow update: if request.auth != null && 
                       (request.auth.uid == resource.data.userId || 
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'dislikes', 'reports']));
    }
  }
}
